# WEB 400 - Laserwall

## Задача
Получить User-agent администратора(первого вошедшего на сервер) из базы данных. Дана ссылка на сайт.

## Легенда
Вот уже несколько световых лет никто не может пройти защиту лаборатории Ваф. Поступила информация, что там давно никого нет. Мы будем признательны, если вы сможете получить какие либо данные о субъектах, которые разработали защиту.

## Условия на сервере
- Сервисы: PHP, Mysql, Apache, ShadowD
- Порт Laserwall: 80
- Порт ShadowD: X *(На ваше усмотрение, он нужен лишь для настройки)*
- Разрешения Mysql пользователя Laserwall: SELECT, INSERT ON *.krasctf
- Разрешения Mysql пользователя ShadowD: ALL GRANTED ON *.shadowd

### Флаг: #1a9e5554de21653f000XXX

## Решение:
Суть таска обойти WAF(Web Application Firewall) - ShadowD. Сам WAF представляет собой сервис куда посылаются данные от пользователя и он возвращает результат проверки. Уязвимость основывается на том, что разработчик думал, что WAF его полностью защищает, и сделал что User-Agent пользователя сохраняется в базу данных при чем не проверяется и не фильтруется, так что возможна SQL-injection при обходе WAF.

Догадаться о существовании инъекции можно по признакам:

1. Записываются UA IP атакующего и выставляются на обозрение
2. При невалидных значениях UA или SHSESSID, которые пройдут проверку WAF, может быть получено исключение БД

Так же можно увидеть, что при первом входе выдается количество пользователей опробовавших сервис, где собственно это число есть порядковый номер пользователя в БД, обозначим его как X.

Пути решения:

1. Задуманный - отправить в поле UA следующие данные: ```UA: 123'), ((SELECT id FROM shadowd_sess LIMIT 1 OFFSET X), (SELECT sess FROM shadowd_sess LIMIT 1)) #```	
2. Незапланированный - отправить в Cookie SHSESSID: ```1' OR '1'='1```

## Развертывание

1. Необходимо установить ShadowD сервис *https://shadowd.zecure.org/overview/shadowd/* 
2. Создать под ShadowD базу данных и импортировать в неё данные ```mysql -ushadowd -p shadowd < /usr/share/shadowd/mysql_layout.sql```
3. Скачать UI для ShadowD *https://shadowd.zecure.org/downloads/archives/* и настроить его *https://shadowd.zecure.org/overview/user_interface/*
4. Настроить профиль защиты согласно конфигурации в файле ```./connectors.ini``` (profile и key), Global threshold выставить на три. Итог должен получится примерно как в файле ```./docs/Shadowd_UI_Profile.jpg```
5. Создать базу данных под Laserwall сервис и импортировать в неё файл ```shadowd.sql```
6. Настроить апач под Laserwall сервис, попробовать открыть его. Если нет ошибок на странице ~~заплакать от счастья, бегать, прыгать, смеяться~~ попробовать имитировать атаку с Impact больше трех *https://shadowd.zecure.org/documentation/blacklist/* и, если получен красный экран ~~крутиться на стуле, наматывая шнур от питания на ножку, кричать в окно у меня получилось~~ значит все удалось

