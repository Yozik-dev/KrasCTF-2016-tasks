# WEB 200 - Lost module

## Задача
Получить картинку с сервера. Даны исходные коды клиента для Google Chrome. 

## Легенда
К нам на планету упал наноспутник наших противников. Передающий модуль уцелел и мы смогли наладить связь с какой-то инфосистемой. На ней мы обнаружили секретные данные, но не смогли их достать...

## Условия на клиенте
- Google Chrome v53 --- *Хотя должно работать и на старых версиях*

## Условия на сервере
- Сервисы: NODEJS
- Порты: 3000

### Флаг: #K32CTF81RUBEN9QV

## Решение:
Устанавливаем расширение (папка client) в Google Chrome браузере в режиме разработчика. После включения видим превью восьми картинок, шесть из которых открыватся в всплывающем окне при нажатии на них, две не доступны.

Изучаем исходных код расширения. После деобфускации background.obf.js в идеале должен получится background.js, конечно он у вас не получится, он дан как исходный. Анализируя деобфусцированный background.js и отправляя с расширения запросы мы можем понять, что существуют параметры без которых запрос не может пройти, а именно: "a", "b", "x", а также заголовок (Header) **X-Hash**. Последний заголовок добавляется в запрос благодаря функциям объекта chrome.webRequest - **onBeforeRequest** и **onBeforeSendHeaders**. Замечаем, что "a", "x" случайные числа, "b" - один набор букв, а X-Hash постоянно меняется, можно сделать выводы:
- "b" - подобие логина
- X-Hash - контрольная сумма запроса (параметров "a", "b", "x") 
После чего пробуем заменить значение "b" на "admin", а так же "b"(_0x900be45bb) в background скрипте на "admin" получим доступ к картинкам secret-*

## Пояснения

1. Для усложнения задания в background.js добавлены функции включения и отключения слушателей на **onBeforeRequest** и **onBeforeSendHeaders**. Включаются они в результате клика по иконке расширения функцией **onRewriteHeaders**. Отключаются при смене активной вкладки браузера и удалении вкладки. При отключеных слушателях заголовок **X-Hash** не добавляется и запросы на сервер выдают 403-юю ошибку.
2. Логин (b) генерируется при установке расширения в background.js и передается в страницу расширения (base.js). В странице расширения он записывается в localStorate и добавляется в параметр "b" при каждом запросе на сервер.
3. Так же логин хранится в бекграунд скрипте и каждый раз участвует в генерации хеша. 

## Развертывание

- Развернуть Express и зависимости ``` npm i ``` в папке server
- Запуск : ``` ./server/bin/www ``` или ``` nodejs ./server/bin/www ```

